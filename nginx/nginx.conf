# ===========================
# nginx.conf — Detailed Explanation
# ===========================

# Define how many worker processes NGINX should spawn.
# "auto" automatically sets it based on the number of available CPU cores.
worker_processes auto;

# ---------------------------
# EVENT BLOCK
# ---------------------------
events {
    # Maximum number of simultaneous connections that can be opened by a worker process.
    # 1024 is usually sufficient for moderate traffic.
    worker_connections 1024;
}

# ---------------------------
# HTTP BLOCK
# ---------------------------
http {
    # ---------------------------
    # UPSTREAM BLOCKS
    # ---------------------------
    # These define backend servers that NGINX can proxy requests to.
    # They act like named load balancer groups for backend services.

    # Upstream for your main backend service (e.g., API, app server)
    upstream backend_service {
        server backend:8000;  # "backend" is the Docker service name, port 8000 exposed inside the Docker network.
    }

    # Upstream for authentication proxy (e.g., service that validates credentials)
    upstream auth_proxy {
        server auth-proxy:8001;  # "auth-proxy" is another container handling authentication logic.
    }

    # ---------------------------
    # SERVER BLOCK
    # ---------------------------
    server {
        # Listen on port 80 for incoming HTTP requests.
        listen 80;

        # ---------------------------
        # MAIN LOCATION — /
        # ---------------------------
        location / {
            # The "auth_request" directive tells NGINX to call an internal location (/auth)
            # before allowing access to the backend.
            # If the auth subrequest returns 2xx → allow the main request.
            # If it returns 401/403 → deny access.
            auth_request /auth;

            # Forward the main (authorized) request to the backend service.
            proxy_pass http://backend_service;

            # Pass user information downstream after successful auth.
            # The variable $remote_user can be set by the auth_request module (if configured).
            proxy_set_header X-User $remote_user;
        }

        # ---------------------------
        # AUTH CHECK LOCATION — /auth
        # ---------------------------
        # This is an internal endpoint used by "auth_request" to verify authentication.
        # It's not accessible to external clients directly.
        location = /auth {
            internal;  # Prevents external access; can only be called internally by NGINX.

            # Forward the authentication check to the auth proxy service.
            # It might validate headers, tokens, or credentials.
            proxy_pass http://auth_proxy/test-auth;

            # Since this is just an authentication check, we disable passing request body.
            # (Auth usually doesn’t need the POST body, just headers.)
            proxy_pass_request_body off;

            # Set an empty Content-Length to avoid issues when no body is sent.
            proxy_set_header Content-Length "";

            # Pass through custom headers used for authentication.
            # The backend auth-proxy can use these headers for validation.
            proxy_set_header X-User $http_x_user;
            proxy_set_header X-Password $http_x_password;
        }

        # ---------------------------
        # HEALTH CHECK LOCATION — /health
        # ---------------------------
        # A simple health endpoint that forwards to the backend's / endpoint (or /health if available).
        # Useful for uptime monitors or container orchestration systems (like Docker, K8s).
        # Optional health check route
        location /auth-proxy-health {
            proxy_pass http://auth_proxy/health;
        }
    }
}
